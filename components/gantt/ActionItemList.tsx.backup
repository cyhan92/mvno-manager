import React, { useState } from 'react'
import { Task } from '../../types/task'
import { getTreeIcon, TreeNode } from '../../utils/tree'
import { TreeState } from '../../types/task'
import { styles } from '../../styles'
import ContextMenu from './ContextMenu'
import MoveMajorCategoryPopup from './MoveMajorCategoryPopup'
import AddActionItemPopupRefactored from './AddActionItemPopupRefactored'
import EditMajorCategoryPopup from './EditMajorCategoryPopup'
import SubCategoryEditPopup from './SubCategoryEditPopup'
import AddMajorCategoryPopup from './AddMajorCategoryPopup'
import DeleteConfirmationPopup from './DeleteConfirmationPopup'

interface ActionItemListProps {
  displayTasks: Task[]
  treeState: TreeState
  onTaskSelect: (task: Task) => void
  onTaskDoubleClick: (task: Task, event: React.MouseEvent) => void
  onTreeToggle: (nodeId: string) => void
  scrollRef: React.RefObject<HTMLDivElement | null>
  onScroll: (e: React.UIEvent<HTMLDivElement>) => void
  showAssigneeInfo: boolean // ë‹´ë‹¹ì ì •ë³´ í‘œì‹œ ì—¬ë¶€
  onTaskAdd?: (newTask: Partial<Task>) => void // ìƒˆë¡œìš´ Task ì¶”ê°€ ì½œë°±
  onMajorCategoryUpdate?: (oldCategory: string, newCategory: string) => Promise<void> // ëŒ€ë¶„ë¥˜ ìˆ˜ì • ì½œë°±
  onSubCategoryUpdate?: (taskId: string, middleCategory: string, subCategory: string, currentMiddleCategory?: string, currentSubCategory?: string) => Promise<void> // ì¤‘ë¶„ë¥˜,ì†Œë¶„ë¥˜ ìˆ˜ì • ì½œë°±
  onTaskUpdate?: (updatedTask: Task) => void // ì‘ì—… ì—…ë°ì´íŠ¸ ì½œë°±
  onTaskDelete?: (taskId: string) => void // ì‘ì—… ì‚­ì œ ì½œë°±
  onDataRefresh?: () => void // ë°ì´í„° ìƒˆë¡œê³ ì¹¨ ì½œë°±
  onOpenTaskDetailPopup?: (task: Task, position: { x: number; y: number }) => void // ì‘ì—… ìƒì„¸ íŒì—… ì—´ê¸° ì½œë°±
  onMoveMajorCategory?: (currentMajorCategory: string, currentMinorCategory: string, targetMajorCategory: string) => Promise<{ success: boolean; updatedCount: number }> // ëŒ€ë¶„ë¥˜ ì´ë™ ì½œë°±
}

const ActionItemList: React.FC<ActionItemListProps> = ({
  displayTasks,
  treeState,
  onTaskSelect,
  onTaskDoubleClick,
  onTreeToggle,
  scrollRef,
  onScroll,
  showAssigneeInfo,
  onTaskAdd,
  onMajorCategoryUpdate,
  onSubCategoryUpdate,
  onTaskUpdate,
  onTaskDelete,
  onDataRefresh,
  onOpenTaskDetailPopup,
  onMoveMajorCategory
}) => {
  // ì»¨í…ìŠ¤íŠ¸ ë©”ë‰´ ìƒíƒœ
  const [contextMenu, setContextMenu] = useState<{
    isOpen: boolean
    position: { x: number; y: number }
    task: Task | null
  }>({
    isOpen: false,
    position: { x: 0, y: 0 },
    task: null
  })

  // Add Action Item íŒì—… ìƒíƒœ
  const [addPopup, setAddPopup] = useState<{
    isOpen: boolean
    position: { x: number; y: number }
    parentTask: Task | null
  }>({
    isOpen: false,
    position: { x: 0, y: 0 },
    parentTask: null
  })

  // Edit Major Category íŒì—… ìƒíƒœ
  const [editMajorCategoryPopup, setEditMajorCategoryPopup] = useState<{
    isOpen: boolean
    position: { x: number; y: number }
    task: Task | null
  }>({
    isOpen: false,
    position: { x: 0, y: 0 },
    task: null
  })

  // Edit Sub Category íŒì—… ìƒíƒœ
  const [editSubCategoryPopup, setEditSubCategoryPopup] = useState<{
    isOpen: boolean
    task: Task | null
  }>({
    isOpen: false,
    task: null
  })

  // Add Major Category íŒì—… ìƒíƒœ
  const [addMajorCategoryPopup, setAddMajorCategoryPopup] = useState<{
    isOpen: boolean
  }>({
    isOpen: false
  })

  // Delete Confirmation íŒì—… ìƒíƒœ
  const [deleteConfirmationPopup, setDeleteConfirmationPopup] = useState<{
    isOpen: boolean
    task: Task | null
    isLoading: boolean
  }>({
    isOpen: false,
    task: null,
    isLoading: false
  })

  // Move Major Category íŒì—… ìƒíƒœ
  const [moveMajorCategoryPopup, setMoveMajorCategoryPopup] = useState<{
    isOpen: boolean
    task: Task | null
  }>({
    isOpen: false,
    task: null
  })

  // ìš°í´ë¦­ ì´ë²¤íŠ¸ í•¸ë“¤ëŸ¬
  const handleContextMenu = (e: React.MouseEvent, task: Task) => {
    e.preventDefault()
    
    // ëŒ€ë¶„ë¥˜(level 0), ì†Œë¶„ë¥˜(level 1), ìƒì„¸ì—…ë¬´(level 2)ì—ì„œ ì»¨í…ìŠ¤íŠ¸ ë©”ë‰´ í‘œì‹œ
    if (task.level === 0 || task.level === 1 || task.level === 2) {
      setContextMenu({
        isOpen: true,
        position: { x: e.clientX, y: e.clientY },
        task
      })
    }
  }

  // ì»¨í…ìŠ¤íŠ¸ ë©”ë‰´ ë‹«ê¸°
  const handleCloseContextMenu = () => {
    setContextMenu({
      isOpen: false,
      position: { x: 0, y: 0 },
      task: null
    })
  }

  // Add Action Item íŒì—… ì—´ê¸°
  const handleOpenAddPopup = () => {
    if (contextMenu.task) {
      setAddPopup({
        isOpen: true,
        position: { x: window.innerWidth / 2 - 300, y: window.innerHeight / 2 - 300 },
        parentTask: contextMenu.task
      })
    }
  }

  // Add Action Item íŒì—… ë‹«ê¸°
  const handleCloseAddPopup = () => {
    setAddPopup({
      isOpen: false,
      position: { x: 0, y: 0 },
      parentTask: null
    })
  }

  // Edit Major Category íŒì—… ì—´ê¸°
  const handleOpenEditMajorCategoryPopup = () => {
    if (contextMenu.task) {
      setEditMajorCategoryPopup({
        isOpen: true,
        position: { x: window.innerWidth / 2 - 250, y: window.innerHeight / 2 - 200 },
        task: contextMenu.task
      })
    }
  }

  // Edit Major Category íŒì—… ë‹«ê¸°
  const handleCloseEditMajorCategoryPopup = () => {
    setEditMajorCategoryPopup({
      isOpen: false,
      position: { x: 0, y: 0 },
      task: null
    })
  }

  // Edit Sub Category íŒì—… ì—´ê¸°
  const handleEditSubCategory = () => {
    console.log(`ğŸ¯ ActionItemList: handleEditSubCategory í˜¸ì¶œ`)
    console.log(`ğŸ“‹ ì„ íƒëœ íƒœìŠ¤í¬:`, contextMenu.task)
    console.log(`ğŸ“‹ íƒœìŠ¤í¬ ìƒì„¸ ì •ë³´:`, {
      id: contextMenu.task?.id,
      name: contextMenu.task?.name,
      middleCategory: contextMenu.task?.middleCategory,
      minorCategory: contextMenu.task?.minorCategory,
      majorCategory: contextMenu.task?.majorCategory,
      level: contextMenu.task?.level,
      isGroup: contextMenu.task?.isGroup
    })
    
    if (contextMenu.task) {
      setEditSubCategoryPopup({
        isOpen: true,
        task: contextMenu.task
      })
    }
  }

  // Edit Sub Category íŒì—… ë‹«ê¸°
  const handleCloseEditSubCategoryPopup = () => {
    setEditSubCategoryPopup({
      isOpen: false,
      task: null
    })
  }

  // Add Major Category íŒì—… ì—´ê¸°
  const handleOpenAddMajorCategoryPopup = () => {
    setAddMajorCategoryPopup({
      isOpen: true
    })
  }

  // Add Major Category íŒì—… ë‹«ê¸°
  const handleCloseAddMajorCategoryPopup = () => {
    setAddMajorCategoryPopup({
      isOpen: false
    })
  }

  // ìƒì„¸ì—…ë¬´ ìˆ˜ì • í•¸ë“¤ëŸ¬ (ë”ë¸”í´ë¦­ê³¼ ë™ì¼)
  const handleEditTask = () => {
    if (contextMenu.task && onOpenTaskDetailPopup) {
      // ì»¨í…ìŠ¤íŠ¸ ë©”ë‰´ ìœ„ì¹˜ë¥¼ ê¸°ë°˜ìœ¼ë¡œ íŒì—… ì—´ê¸°
      onOpenTaskDetailPopup(contextMenu.task, {
        x: contextMenu.position.x + 10,
        y: contextMenu.position.y
      })
    }
  }

  // ìƒì„¸ì—…ë¬´ ì‚­ì œ í•¸ë“¤ëŸ¬
  const handleDeleteTask = () => {
    if (contextMenu.task) {
      setDeleteConfirmationPopup({
        isOpen: true,
        task: contextMenu.task,
        isLoading: false
      })
    }
  }

  // Delete Confirmation íŒì—… ë‹«ê¸°
  const handleCloseDeleteConfirmationPopup = () => {
    setDeleteConfirmationPopup({
      isOpen: false,
      task: null,
      isLoading: false
    })
  }

  // Move Major Category íŒì—… ì—´ê¸°
  const handleMoveMajorCategory = () => {
    if (contextMenu.task) {
      setMoveMajorCategoryPopup({
        isOpen: true,
        task: contextMenu.task
      })
    }
  }

  // Move Major Category íŒì—… ë‹«ê¸°
  const handleCloseMoveMajorCategoryPopup = () => {
    setMoveMajorCategoryPopup({
      isOpen: false,
      task: null
    })
  }

  // ëŒ€ë¶„ë¥˜ ì´ë™ ì‹¤í–‰
  const handleExecuteMoveMajorCategory = async (targetMajorCategory: string) => {
    if (!moveMajorCategoryPopup.task || !onMoveMajorCategory) {
      throw new Error('í•„ìš”í•œ ì •ë³´ê°€ ì—†ìŠµë‹ˆë‹¤.')
    }

    const task = moveMajorCategoryPopup.task
    
    if (!task.majorCategory || !task.minorCategory) {
      const error = 'ëŒ€ë¶„ë¥˜ ë˜ëŠ” ì†Œë¶„ë¥˜ ì •ë³´ê°€ ì—†ìŠµë‹ˆë‹¤.'
      alert(error)
      throw new Error(error)
    }

    try {
      const result = await onMoveMajorCategory(
        task.majorCategory,
        task.minorCategory,
        targetMajorCategory
      )

      console.log('âœ… ëŒ€ë¶„ë¥˜ ì´ë™ ì™„ë£Œ:', result)
      // ì„±ê³µ ì‹œì—ëŠ” íŒì—…ì„ í‘œì‹œí•˜ì§€ ì•ŠìŒ (ë¡œê·¸ë§Œ ì¶œë ¥)
      
    } catch (error) {
      console.error('âŒ ëŒ€ë¶„ë¥˜ ì´ë™ ì‹¤íŒ¨:', error)
      const errorMessage = `ëŒ€ë¶„ë¥˜ ì´ë™ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ${error}`
      alert(errorMessage)
      throw error // ì—ëŸ¬ë¥¼ ë‹¤ì‹œ throwí•˜ì—¬ ìƒìœ„ ì»´í¬ë„ŒíŠ¸ì—ì„œ ì²˜ë¦¬í•  ìˆ˜ ìˆë„ë¡ í•¨
    }
  }

  // ì¤‘ë¶„ë¥˜,ì†Œë¶„ë¥˜ ìˆ˜ì • í•¸ë“¤ëŸ¬
  const handleSubCategoryUpdate = async (taskId: string, middleCategory: string, subCategory: string, currentMiddleCategory?: string, currentSubCategory?: string) => {
    console.log(`ğŸ¯ ActionItemList: handleSubCategoryUpdate í˜¸ì¶œ`)
    console.log(`ğŸ“‹ íŒŒë¼ë¯¸í„°:`, { taskId, middleCategory, subCategory, currentMiddleCategory, currentSubCategory })
    console.log(`ğŸ”— onSubCategoryUpdate í•¨ìˆ˜ ì¡´ì¬:`, !!onSubCategoryUpdate)
    
    if (onSubCategoryUpdate) {
      try {
        console.log(`ğŸš€ ìƒìœ„ onSubCategoryUpdate í•¨ìˆ˜ í˜¸ì¶œ`)
        // onSubCategoryUpdate í•¨ìˆ˜ê°€ 5ê°œ íŒŒë¼ë¯¸í„°ë¥¼ ë°›ë„ë¡ ìˆ˜ì •ì´ í•„ìš”í•  ìˆ˜ ìˆìŒ
        await onSubCategoryUpdate(taskId, middleCategory, subCategory, currentMiddleCategory, currentSubCategory)
        console.log(`âœ… ìƒìœ„ í•¨ìˆ˜ í˜¸ì¶œ ì™„ë£Œ`)
        // ì„±ê³µì‹œ íŒì—… ë‹«ê¸°
        handleCloseEditSubCategoryPopup()
      } catch (error) {
        console.error('âŒ ì¤‘ë¶„ë¥˜,ì†Œë¶„ë¥˜ ìˆ˜ì • ì‹¤íŒ¨:', error)
      }
    } else {
      console.warn(`âš ï¸ onSubCategoryUpdate í•¨ìˆ˜ê°€ ì „ë‹¬ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤`)
    }
  }

  // ìƒˆë¡œìš´ Task ì¶”ê°€ í•¸ë“¤ëŸ¬
  const handleAddTask = (newTask: Partial<Task>) => {
    try {
      console.log('ActionItemList: ìƒˆ ì‘ì—… ì¶”ê°€ ìš”ì²­:', newTask)
      
      if (!newTask) {
        throw new Error('ìƒˆ ì‘ì—… ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.')
      }

      if (!newTask.name || !newTask.name.trim()) {
        throw new Error('ì‘ì—…ëª…ì´ í•„ìš”í•©ë‹ˆë‹¤.')
      }

      if (onTaskAdd) {
        onTaskAdd(newTask)
        console.log('ActionItemList: ìƒˆ ì‘ì—… ì¶”ê°€ ì™„ë£Œ')
        
        // íŒì—… ë‹«ê¸°
        handleCloseAddPopup()
      } else {
        console.warn('ActionItemList: onTaskAdd í•¨ìˆ˜ê°€ ì „ë‹¬ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.')
      }
    } catch (error) {
      console.error('ActionItemList: ì‘ì—… ì¶”ê°€ ì‹¤íŒ¨:', error)
      alert(`ì‘ì—… ì¶”ê°€ ì‹¤íŒ¨: ${error instanceof Error ? error.message : 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜'}`)
    }
  }

  // ëŒ€ë¶„ë¥˜ ì¶”ê°€ í•¸ë“¤ëŸ¬
  const handleAddMajorCategory = async (majorCategory: string) => {
    try {
      // ê¸°ë³¸ ì‘ì—… ë°ì´í„° ìƒì„±
      const newTask: Partial<Task> = {
        name: 'ìƒì„¸ì—…ë¬´_1',
        majorCategory: majorCategory,
        middleCategory: 'ì¤‘ë¶„ë¥˜_1',
        minorCategory: 'ì†Œë¶„ë¥˜_1',
        start: new Date(),
        end: new Date(Date.now() + 7 * 24 * 60 * 60 * 1000), // 7ì¼ í›„
        percentComplete: 0,
        resource: '',
        department: '',
        status: 'TODO',
        level: 2
      }

      if (onTaskAdd) {
        onTaskAdd(newTask)
      }

      // ë°ì´í„° ìƒˆë¡œê³ ì¹¨
      if (onDataRefresh) {
        onDataRefresh()
      }
    } catch (error) {
      console.error('ëŒ€ë¶„ë¥˜ ì¶”ê°€ ì‹¤íŒ¨:', error)
      throw error
    }
  }

  // ì‘ì—… ì‚­ì œ í•¸ë“¤ëŸ¬ (DeleteConfirmationPopupì—ì„œ í˜¸ì¶œ)
  const handleConfirmDelete = async (password: string) => {
    if (deleteConfirmationPopup.task && onTaskDelete) {
      try {
        // ë¡œë”© ìƒíƒœ ì‹œì‘
        setDeleteConfirmationPopup(prev => ({
          ...prev,
          isLoading: true
        }))

        // ì‘ì—… ì‚­ì œ (useTaskManagerì—ì„œ ì´ë¯¸ ë¶€ë¶„ ë¦¬í”„ë ˆì‹œ ì²˜ë¦¬ë¨)
        onTaskDelete(deleteConfirmationPopup.task.id)
        handleCloseDeleteConfirmationPopup()
        
        // onDataRefresh í˜¸ì¶œ ì œê±° - useTaskManagerì—ì„œ ì´ë¯¸ ë¡œì»¬ ìƒíƒœ ì—…ë°ì´íŠ¸ ì²˜ë¦¬
        console.log('âœ… ì‚­ì œ ì™„ë£Œ - ë¶€ë¶„ ë¦¬í”„ë ˆì‹œë¡œ ì²˜ë¦¬ë¨')
      } catch (error) {
        console.error('ì‘ì—… ì‚­ì œ ì‹¤íŒ¨:', error)
        // ë¡œë”© ìƒíƒœ ì¢…ë£Œ
        setDeleteConfirmationPopup(prev => ({
          ...prev,
          isLoading: false
        }))
      }
    }
  }

  // ì¤‘ë¶„ë¥˜,ì†Œë¶„ë¥˜ ì¶”ê°€ í•¸ë“¤ëŸ¬
  const handleOpenAddSubCategoryPopup = () => {
    if (contextMenu.task) {
      setEditSubCategoryPopup({
        isOpen: true,
        task: contextMenu.task
      })
    }
  }

  // ìƒˆë¡œìš´ SubCategory ìƒíƒœ (ì¶”ê°€ ëª¨ë“œìš©)
  const [addSubCategoryPopup, setAddSubCategoryPopup] = useState<{
    isOpen: boolean
    task: Task | null
  }>({
    isOpen: false,
    task: null
  })

  // ì¤‘ë¶„ë¥˜,ì†Œë¶„ë¥˜ ì¶”ê°€ íŒì—… ì—´ê¸°
  const handleOpenAddSubCategoryPopupForNew = () => {
    if (contextMenu.task) {
      setAddSubCategoryPopup({
        isOpen: true,
        task: contextMenu.task
      })
    }
  }

  // ì¤‘ë¶„ë¥˜,ì†Œë¶„ë¥˜ ì¶”ê°€ íŒì—… ë‹«ê¸°
  const handleCloseAddSubCategoryPopup = () => {
    setAddSubCategoryPopup({
      isOpen: false,
      task: null
    })
  }

  // ëŒ€ë¶„ë¥˜ ìˆ˜ì • í•¸ë“¤ëŸ¬
  const handleMajorCategoryUpdate = async (oldCategory: string, newCategory: string) => {
    console.log(`ğŸ¯ ActionItemList: handleMajorCategoryUpdate í˜¸ì¶œ`)
    console.log(`ğŸ“‹ íŒŒë¼ë¯¸í„°:`, { oldCategory, newCategory })
    console.log(`ğŸ”— onMajorCategoryUpdate í•¨ìˆ˜ ì¡´ì¬:`, !!onMajorCategoryUpdate)
    
    if (onMajorCategoryUpdate) {
      try {
        console.log(`ğŸš€ ìƒìœ„ onMajorCategoryUpdate í•¨ìˆ˜ í˜¸ì¶œ`)
        await onMajorCategoryUpdate(oldCategory, newCategory)
        console.log(`âœ… ìƒìœ„ í•¨ìˆ˜ í˜¸ì¶œ ì™„ë£Œ`)
      } catch (error) {
        console.error(`âŒ ìƒìœ„ í•¨ìˆ˜ í˜¸ì¶œ ì‹¤íŒ¨:`, error)
        throw error
      }
    } else {
      console.warn(`âš ï¸ onMajorCategoryUpdate í•¨ìˆ˜ê°€ ì „ë‹¬ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤`)
    }
  }

  return (
    <div className={`${styles.actionItemArea} flex-shrink-0`}>
      <div className={styles.actionItemHeader}>
        <h4 className="font-semibold text-gray-700">ğŸ“‹ Action Items</h4>
      </div>
      <div 
        ref={scrollRef}
        className={`${styles.actionItemList} ${styles.actionItemListDynamic}`}
        onScroll={onScroll}
      >
        {displayTasks.map((task, index) => (
          <div 
            key={task.id}
            className={`${styles.actionItemRow} ${
              index % 2 === 0 ? styles.actionItemRowEven : styles.actionItemRowOdd
            } ${task.hasChildren ? styles.actionItemRowGroup : styles.actionItemRowLeaf} ${
              styles[`treeLevel${task.level || 0}`]
            }`}
            onClick={() => {
              if (task.hasChildren) {
                // ìì‹ì´ ìˆëŠ” ê²½ìš° í™•ëŒ€/ì¶•ì†Œ
                onTreeToggle(task.id)
              } else {
                // ìì‹ì´ ì—†ëŠ” ê²½ìš° ì‘ì—… ì„ íƒ
                onTaskSelect(task)
              }
            }}
            onDoubleClick={(e) => onTaskDoubleClick(task, e)}
            onContextMenu={(e) => handleContextMenu(e, task)}
          >
            <div className={styles.treeNode}>
              {/* í† ê¸€ ë²„íŠ¼ ë˜ëŠ” ë¹ˆ ê³µê°„ */}
              {task.hasChildren ? (
                <div 
                  className={styles.treeToggle}
                  onClick={(e) => {
                    e.stopPropagation()
                    onTreeToggle(task.id)
                  }}
                >
                  {treeState.isExpanded(task.id) ? 'âˆ’' : '+'}
                </div>
              ) : (
                <div className={styles.treeToggleEmpty} />
              )}
              
              {/* ì•„ì´ì½˜ */}
              <span className={styles.treeIcon}>
                {getTreeIcon(task as TreeNode, treeState.isExpanded(task.id))}
              </span>
              
              {/* í…ìŠ¤íŠ¸ */}
              <div className={styles.treeText}>
                <span className={task.percentComplete === 100 ? 'text-gray-400' : ''}>
                  {/* ì†Œë¶„ë¥˜ëŠ” ì´ë¯¸ "[ì¤‘ë¶„ë¥˜] ì†Œë¶„ë¥˜" í˜•ì‹ìœ¼ë¡œ ë¹Œë“œë¨ */}
                  {(() => {
                    const taskName = task.name || task.detail || `ì‘ì—… ${index + 1}`
                    
                    // level 1 (ì†Œë¶„ë¥˜)ì´ê³  "[ì¤‘ë¶„ë¥˜] ì†Œë¶„ë¥˜" í˜•ì‹ì¸ ê²½ìš° ìŠ¤íƒ€ì¼ë§ ì ìš©
                    if (task.level === 1 && taskName.match(/^\[([^\]]+)\]\s*(.*)/)) {
                      const middleCategoryMatch = taskName.match(/^\[([^\]]+)\]\s*(.*)/)
                      if (middleCategoryMatch) {
                        const [, middleCategory, remainingName] = middleCategoryMatch
                        return (
                          <>
                            <span className="text-xs text-gray-500">[{middleCategory}]</span>
                            <span className="ml-1">{remainingName}</span>
                          </>
                        )
                      }
                    }
                    
                    return taskName
                  })()}
                </span>
                {/* ë‹´ë‹¹ì ì •ë³´ í‘œì‹œ (ì„¸ë¶€ì—…ë¬´ë§Œ) */}
                {showAssigneeInfo && !task.hasChildren && (
                  <span className="text-xs text-gray-500 ml-2">
                    ({task.department || 'ë¯¸ì •'}/{task.resource || 'ë¯¸ì •'})
                  </span>
                )}
              </div>
            </div>
          </div>
        ))}
      </div>

      {/* ì»¨í…ìŠ¤íŠ¸ ë©”ë‰´ */}
      <ContextMenu
        isOpen={contextMenu.isOpen}
        position={contextMenu.position}
        task={contextMenu.task}
        onClose={handleCloseContextMenu}
        onAddActionItem={handleOpenAddPopup}
        onEditMajorCategory={handleOpenEditMajorCategoryPopup}
        onEditSubCategory={handleEditSubCategory}
        onAddSubCategory={handleOpenAddSubCategoryPopupForNew}
        onAddMajorCategory={handleOpenAddMajorCategoryPopup}
        onEditTask={handleEditTask}
        onDeleteTask={handleDeleteTask}
        onMoveMajorCategory={handleMoveMajorCategory}
      />

      {/* Add Action Item íŒì—… */}
      {addPopup.parentTask && (
        <AddActionItemPopupRefactored
          isOpen={addPopup.isOpen}
          position={addPopup.position}
          parentTask={addPopup.parentTask}
          onClose={handleCloseAddPopup}
          onAdd={handleAddTask}
        />
      )}

      {/* Edit Major Category íŒì—… */}
      {editMajorCategoryPopup.task && (
        <EditMajorCategoryPopup
          isOpen={editMajorCategoryPopup.isOpen}
          position={editMajorCategoryPopup.position}
          task={editMajorCategoryPopup.task}
          onClose={handleCloseEditMajorCategoryPopup}
          onSave={handleMajorCategoryUpdate}
        />
      )}

      {/* Edit Sub Category íŒì—… */}
      {editSubCategoryPopup.task && (
        <SubCategoryEditPopup
          isOpen={editSubCategoryPopup.isOpen}
          task={editSubCategoryPopup.task}
          currentMiddleCategory={editSubCategoryPopup.task.middleCategory}
          currentSubCategory={editSubCategoryPopup.task.minorCategory}
          onClose={handleCloseEditSubCategoryPopup}
          onUpdateSubCategory={handleSubCategoryUpdate}
          mode="edit"
        />
      )}

      {/* Add Sub Category íŒì—… */}
      {addSubCategoryPopup.task && (
        <SubCategoryEditPopup
          isOpen={addSubCategoryPopup.isOpen}
          task={addSubCategoryPopup.task}
          currentMiddleCategory={addSubCategoryPopup.task.middleCategory}
          currentSubCategory=""
          onClose={handleCloseAddSubCategoryPopup}
          onUpdateSubCategory={handleSubCategoryUpdate}
          mode="add"
          onAddTask={handleAddTask}
        />
      )}

      {/* Add Major Category íŒì—… */}
      <AddMajorCategoryPopup
        isOpen={addMajorCategoryPopup.isOpen}
        onClose={handleCloseAddMajorCategoryPopup}
        onAdd={handleAddMajorCategory}
      />

      {/* Delete Confirmation íŒì—… */}
      {deleteConfirmationPopup.task && (
        <DeleteConfirmationPopup
          isOpen={deleteConfirmationPopup.isOpen}
          task={deleteConfirmationPopup.task}
          onClose={handleCloseDeleteConfirmationPopup}
          onConfirm={handleConfirmDelete}
          isLoading={deleteConfirmationPopup.isLoading}
        />
      )}

      {/* Move Major Category íŒì—… */}
      {moveMajorCategoryPopup.task && (
        <MoveMajorCategoryPopup
          isOpen={moveMajorCategoryPopup.isOpen}
          task={moveMajorCategoryPopup.task}
          tasks={displayTasks}
          onClose={handleCloseMoveMajorCategoryPopup}
          onMove={handleExecuteMoveMajorCategory}
        />
      )}
    </div>
  )
}

export default ActionItemList
